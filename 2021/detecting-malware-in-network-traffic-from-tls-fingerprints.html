<html>

<head>
	<!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-M6KVQ3TNZY"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-M6KVQ3TNZY');
    </script>
    <title>Detecting Malware in Network Traffic from TLS Fingerprints</title>
	<link rel = "stylesheet" type = "text/css" href = "../essay.css" />
</head>

<body>
<section>
	<div class="essay">
        <h1><center>Detecting Malware in Network Traffic from TLS Fingerprints</center></h1>
        <h3>Introduction</h3>
        <p>An increasing percentage of malware use encrypted traffic to communicate with their command and control server. Hence it becomes difficult to detect malware from the payload when the malware is communicating via a TLS connection. When a client application establishes connection with it's server, the client application does so by performing TLS handshakes with the server. This communication is not encrypted and it can help in detecting malware since it provides us with a set of observable features.
        </p>
        <p>To intiate communication via TLS, the client application first sends a client hello packet for which the server responds with a server hello packet. From the client hello packet, the following fields will be of interest to construct the fingerprint string: the TLS versions, a list of offered cipher suites, elliptic curve formats, elliptic curve point formats and extensions. The server responds to the client hello with a server hello packet containing the following fields of interest for fingerprinting: the selected TLS protocol version, the selected cipher suite and compression method and a list of extensions. The client presents the ciphersuites in decreasing order of preference from which the server chooses the ciphersuite which it can satisfy with the highest preference.
        </p>
        <h3>Detecting malware from TLS fingerprints</h3>
            <p>The following are few methods which can be utilized for detecting malware from TLS Fingerprint string.</p>
        <h3>Using a fingerprint database to detect client application</h3>
        <p>Every client application has a TLS fingerprint associated with it. A fingerprint database of known fingerprint and the associated process can be collected to detect the process associated with the fingerprint. A connection is suspicious when an unknown fingerprint is encountered. Cisco provides an open database of the fingerprints and the process as part of their tool <a href="https://github.com/cisco/mercury">mercury</a>.
        Benign applications (like traffic from an enterprise network) update their application regulary and use the latest security features and protocols. For example, most of the benign applications use the latest version of Firefox browser but malwares use older version of Firefox browser. Malwares make advantage of an bug or security loophole in the older version of the application. A fingerprint associated with an older application process can signal a presence of malicious activity.
        </p>
        <h3>Classifier based approach</h3>
        Malware applications sometimes use older version of security protocols and the ciphersuites offered by them differ from the ciphersuites offered by benign applications. Similarly, the encryption algorithm, the advertised TLS extension can help in building feature set for a classifier model based on machine learning techniques like logistic regression or random forest to detect malware from the client hello packet. Such a technique has been used in <a href="#anderson_2018">Anderson et al, 2018.</a>.

        <h3>Drawbacks</h3>
        <p>A significant drawback of using the fingerprint based approach is the high number of false positives it generates. A fingerprint can match to more than one process and in that case, it will be difficult to detect the process which has generated the fingerprint. For example, <a href="https://abuse.ch/">Abuse.Ch</a> reports a set of fingerprints which belongs to malwares but also cautions that these fingerprints might also match benign process.</p>

        <p>In the paper <a href="#anderson_2020">Anderson et al, 2020</a>, the knowledge of processes which produce a fingerprint and destination context in which the fingerprint is observed is used to find the process generating the fingerprint using a naive bayes classifier. A caveat here is that the detection approach depends on the fingerprint database. It involves regular updation of fingerprint database to detect process accurately which may not be possible in all network settings. </p>

        <p>One may wonder why client fingerprints are used rather than the server fingerprints. The use of server fingerprints also suffers from the problem of falsepositives. Moreover, a server application may choose a random ciphersuite instead of the highest preference ciphersuite offered by the client. By this way, a malicious server can evade being detected.</p>
        <p>In the next blog post, we will discuss tools for capturing fingerprint from network traffic.</p>
        <h3>References</h3>
        <ul>
            <li>This <a href="https://tls.ulfheim.net/">site</a> has a good description of an TLS connection.
            <li id="anderson_2018"> <a href="https://arxiv.org/pdf/1607.01639">Anderson, B., Paul, S., and McGrew, D. (2018). Deciphering malwareâ€™s use of TLS (without decryption). Journal of Computer Virology and Hacking Techniques, 14(3), 195-211.</a>
           <li id="anderson_2020"><a href="https://arxiv.org/abs/2009.01939">Anderson, Blake, and David McGrew. "Accurate TLS Fingerprinting using Destination Context and Knowledge Bases." arXiv preprint arXiv:2009.01939(2020).</a>
        </ul>
	</div>

	<div class="authors">
		Written by Arun Thiagarajan, 06-April-2021
	</div>

</section>
</body>
</html>


